pipeline {

	agent {
		label 'coronado || Pismo || San-clemente || Sugarloaf'
	}

	stages {

		stage ('build and analyze') {
			steps {
				withCredentials([usernamePassword(credentialsId: '9db65bd3-f8f0-4de0-b344-449ae2782b86', passwordVariable: 'DOCKER_LOGIN_PASSWORD', usernameVariable: 'DOCKER_LOGIN_USERNAME')]) {
				script {
					def statusCode = sh returnStatus: true, script:
					'''
						# don't echo commands by default
						set +x

						# setup env
						export JAVA_HOME=/usr/lib/jvm/java-1.8.0
						export BUCK_HOME=/usr/local/bin
						export BUCK_OUT="${WORKSPACE}/buck-out"
						export WATCHMAN_HOME=/opt/watchman
						export PATH=\$JAVA_HOME/bin:\$MAVEN_HOME/bin:/usr/local/bin:/usr/bin
						export LD_LIBRARY_PATH=/usr/local/lib64:/usr/local/lib:/usr/lib64:/usr/lib
						export BRANCH_NAME="${GIT_BRANCH#origin/}"
						export BUILD_DATE=`date +%Y%m%d`
						export REPO_REV_SHORT=`git rev-parse --short HEAD`
						# remove forward slash and release from branch name
						export BRANCH_VERSION=`echo ${BRANCH_NAME} | sed -e 's/\\//_/g' -e 's/^release_//g'`
						export SEQBASETAG="${BRANCH_VERSION}+b${BUILD_NUMBER}.r${REPO_REV_SHORT}.${BUILD_DATE}"

						# setup env for Semmle
						export SEMMLE_DIR="/home/seqbamboo/semmle/odasa"
						export SEMMLE_PROJ="aerie_java"

						echo -e "\ncurrent environment variables:\n"
						env | sort

						# run semmle script
						$SEMMLE_DIR/queries/suites/security/run_semmle_java.sh "$SEMMLE_PROJ" "`pwd`" "buck build //..." "echo clean not needed"

						# copy generated semmle files to current dir
						cp cwe_output/*.csv ${SEMMLE_PROJ}-semmle-cwe_output-${SEQBASETAG}.csv
						cp JPLTop25_output/*.csv ${SEMMLE_PROJ}-semmle-JPLTop25_output-${SEQBASETAG}.csv
					'''
					if (statusCode > 0) {
						error "Build failure detected. See log."
					}
				}
				}
			}
		}

		stage ('publish') {
			steps {
				echo "Archiving artifacts in Jenkins..."
				archiveArtifacts '*.csv'
			}
		}

	}

	post {

		success {
			emailext subject: "Semmle scan: ${env.JOB_BASE_NAME} #${env.BUILD_NUMBER}",
			body: """
				<p>Semmle scan results for Aerie Java components are now available: <br> <a href=\"${env.BUILD_URL}\">${env.JOB_NAME} #${env.BUILD_NUMBER}</a></p>
			""",
			mimeType: 'text/html',
			to: 'seq.scan@jpl.nasa.gov'
		}

		unstable {
			emailext subject: "Jenkins UNSTABLE: ${env.JOB_BASE_NAME} #${env.BUILD_NUMBER}",
			body: """
				<p>Jenkins job unstable (failed tests): <br> <a href=\"${env.BUILD_URL}\">${env.JOB_NAME} #${env.BUILD_NUMBER}</a></p>
			""",
			mimeType: 'text/html',
			recipientProviders: [[$class: 'FailingTestSuspectsRecipientProvider']]
		}

		failure {
			emailext subject: "Jenkins FAILURE: ${env.JOB_BASE_NAME} #${env.BUILD_NUMBER}",
			body: """
				<p>Jenkins job failure: <br> <a href=\"${env.BUILD_URL}\">${env.JOB_NAME} #${env.BUILD_NUMBER}</a></p>
			""",
			mimeType: 'text/html',
			recipientProviders: [[$class: 'CulpritsRecipientProvider']]
		}
	}

}
